!function(){var e,t,n;!function(i){function r(e,t){return q.call(e,t)}function s(e,t){var n,i,r,s,o,u,a,l,c,d,h,f=t&&t.split("/"),p=v.map,_=p&&p["*"]||{};if(e&&"."===e.charAt(0))if(t){for(f=f.slice(0,f.length-1),e=e.split("/"),o=e.length-1,v.nodeIdCompat&&x.test(e[o])&&(e[o]=e[o].replace(x,"")),e=f.concat(e),c=0;c<e.length;c+=1)if(h=e[c],"."===h)e.splice(c,1),c-=1;else if(".."===h){if(1===c&&(".."===e[2]||".."===e[0]))break;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((f||_)&&p){for(n=e.split("/"),c=n.length;c>0;c-=1){if(i=n.slice(0,c).join("/"),f)for(d=f.length;d>0;d-=1)if(r=p[f.slice(0,d).join("/")],r&&(r=r[i])){s=r,u=c;break}if(s)break;!a&&_&&_[i]&&(a=_[i],l=c)}!s&&a&&(s=a,u=l),s&&(n.splice(0,u,s),e=n.join("/"))}return e}function o(e,t){return function(){return f.apply(i,w.call(arguments,0).concat([e,t]))}}function u(e){return function(t){return s(t,e)}}function a(e){return function(t){g[e]=t}}function l(e){if(r(m,e)){var t=m[e];delete m[e],y[e]=!0,h.apply(i,t)}if(!r(g,e)&&!r(y,e))throw new Error("No "+e);return g[e]}function c(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function d(e){return function(){return v&&v.config&&v.config[e]||{}}}var h,f,p,_,g={},m={},v={},y={},q=Object.prototype.hasOwnProperty,w=[].slice,x=/\.js$/;p=function(e,t){var n,i=c(e),r=i[0];return e=i[1],r&&(r=s(r,t),n=l(r)),r?e=n&&n.normalize?n.normalize(e,u(t)):s(e,t):(e=s(e,t),i=c(e),r=i[0],e=i[1],r&&(n=l(r))),{f:r?r+"!"+e:e,n:e,pr:r,p:n}},_={require:function(e){return o(e)},exports:function(e){var t=g[e];return"undefined"!=typeof t?t:g[e]={}},module:function(e){return{id:e,uri:"",exports:g[e],config:d(e)}}},h=function(e,t,n,s){var u,c,d,h,f,v,q=[],w=typeof n;if(s=s||e,"undefined"===w||"function"===w){for(t=!t.length&&n.length?["require","exports","module"]:t,f=0;f<t.length;f+=1)if(h=p(t[f],s),c=h.f,"require"===c)q[f]=_.require(e);else if("exports"===c)q[f]=_.exports(e),v=!0;else if("module"===c)u=q[f]=_.module(e);else if(r(g,c)||r(m,c)||r(y,c))q[f]=l(c);else{if(!h.p)throw new Error(e+" missing "+c);h.p.load(h.n,o(s,!0),a(c),{}),q[f]=g[c]}d=n?n.apply(g[e],q):void 0,e&&(u&&u.exports!==i&&u.exports!==g[e]?g[e]=u.exports:d===i&&v||(g[e]=d))}else e&&(g[e]=n)},e=t=f=function(e,t,n,r,s){if("string"==typeof e)return _[e]?_[e](t):l(p(e,t).f);if(!e.splice){if(v=e,v.deps&&f(v.deps,v.callback),!t)return;t.splice?(e=t,t=n,n=null):e=i}return t=t||function(){},"function"==typeof n&&(n=r,r=s),r?h(i,e,t,n):setTimeout(function(){h(i,e,t,n)},4),f},f.config=function(e){return f(e)},e._defined=g,n=function(e,t,n){t.splice||(n=t,t=[]),r(g,e)||r(m,e)||(m[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("event-dispatcher",[],function(){"use strict";var e=function(){this._events={}},t=e.prototype;return t.on=function(e,t){var n=this._events[e];return n||(n=this._events[e]=[]),~n.indexOf(t)||n.push(t),this},t.off=function(e,t){var n=this._events[e];if("undefined"==typeof t&&n)delete this._events[e];else{var i=n?n.indexOf(t):-1;~i&&n.splice(i,1)}return this},t.trigger=function(e,t,n){var i=this._events[e]||[];t=t||[];var r=!0;return i.forEach(function(e){var n=e.apply(this,t);n=n!==!1?!0:!1,r=r&&n},n),r},e}),n("utilities",[],function(){"use strict";function e(e,t){return e=JSON.parse(JSON.stringify(e||{})),t=JSON.parse(JSON.stringify(t||{})),Object.keys(t).forEach(function(n){e[n]=t[n]}),e}return{extend:e}}),n("modules/http",["event-dispatcher","utilities"],function(e,t){"use strict";var n=function(n,i){e.call(this),i=t.extend({endpoint:"./server/speedtest.php",delay:8e3},i),this._options=i,this._moduleName=n,this._xhr=null,this._lastURLToken=null,this._requestingOverridden=!1,this._requesting=!1,this._initHttpConfig()},i=n.prototype=Object.create(e.prototype);return i.isRequesting=function(){return this._requesting},i._initHttpConfig=function(){var e=this,t=function(){e._requestingOverridden||(e._requesting=!0)};this.on("xhr-loadstart",t),this.on("xhr-upload-loadstart",t);var n=function(){e._requestingOverridden||(e._requesting=!1)};this.on("xhr-loadend",n),this.on("xhr-upload-loadend",n)},i._newRequest=function(e,t){if(!this.trigger("_newRequest")&&!this._requestingOverridden)return console.warn("To ensure accurate measures, you can only make one request at a time."),this;var n=this,i=this._options,r=new XMLHttpRequest,s=["GET","POST"];if(!~s.indexOf(e))return console.warn("The HTTP method must be GET or POST."),this;t=t||{},r.timeout=i.delay,this._lastURLToken="speedtest-"+(new Date).getTime();var o=i.endpoint;o+=(~o.indexOf("?")?"&":"?")+"module="+this._moduleName,Object.keys(t).forEach(function(e){o+="&"+e+"="+encodeURIComponent(t[e])}),o+="&"+this._lastURLToken,r.open(e,o),this._xhr&&this._xhr.readyState==XMLHttpRequest.OPENED&&this._xhr.abort(),this._xhr=r;var u=["loadstart","progress","abort","error","load","timeout","loadend","readystatechange"];return u.forEach(function(e){r.addEventListener(e,function(){("progress"!=e||n._requesting)&&n.trigger("xhr-"+e,arguments,r)}),"readystatechange"!=e&&r.upload.addEventListener(e,function(){n.trigger("xhr-upload-"+e,arguments,r)})}),this},i._sendRequest=function(e){return this._xhr&&this._xhr.readyState==XMLHttpRequest.OPENED?this._xhr.send("undefined"!=typeof e?e:null):console.warn("A request must have been created before it can be sent."),this},i._abortRequest=function(){},i._getTimingEntry=function(e){return setTimeout(function(t){return function(){var n=performance.getEntriesByType("resource").filter(function(e){return~e.name.indexOf(t)});"function"==typeof e&&e(n.length?n[0]:null)}}(this._lastURLToken),0),this},i._setRequesting=function(e){this._requestingOverridden=!0,this._requesting=e},n}),n("timing",[],function(){"use strict";var e=function(){},t=e;return t._marks={},t._measures={},t._support={performance:!!window.performance,userTiming:window.performance&&performance.mark,resourceTiming:window.performance&&performance.timing},t.mark=function(e){var t=this._support,n=this._marks;return t.userTiming?performance.mark(e):n[e]=t.performance?performance.now():(new Date).getTime(),this},t.measure=function(e,t,n){var i=this._support,r=this._marks,s=this._measures;return"undefined"==typeof s[e]&&(i.userTiming?(performance.measure(e,t,n),s[e]=performance.getEntriesByName(e)[0].duration):s[e]=r[n]-r[t]),s[e]},t.supportsResourceTiming=function(){return this._support.resourceTiming},e}),n("modules/latency",["modules/http","timing","utilities"],function(e,t,n){"use strict";var i=function(t){t=n.extend(t,{delay:0}),e.call(this,"latency",t),this._requestsLeft=0,this._latencies=[],this._requestID=0,this._timingLabels={start:null,end:null,measure:null},this._initLatencyConfig()},r=i.prototype=Object.create(e.prototype);return r.start=function(){return this._requestsLeft=5,t.supportsResourceTiming()||this._requestsLeft++,this._setRequesting(!0),this._latencies=[],this._nextRequest(),this},r._initLatencyConfig=function(){var e=this;if(t.supportsResourceTiming())this.on("xhr-load",function(){e._getTimingEntry(function(t){var n=t.secureConnectionStart?t.secureConnectionStart-t.connectStart:t.connectEnd-t.connectStart;e._latencies.push(n)})});else{var n=this._timingLabels;this.on("xhr-loadstart",function(){t.mark(n.start)}),this.on("xhr-readystatechange",function(){e._requestsLeft<5&&this.readyState==XMLHttpRequest.HEADERS_RECEIVED&&(t.mark(n.end),e._latencies.push(t.measure(n.measure,n.start,n.end)))})}this.on("xhr-load",function(){e._nextRequest()})},r._nextRequest=function(){if(this._requestsLeft--){var e=this._requestID++,t=this._timingLabels;t.start="latency-"+e+"-start",t.end="latency-"+e+"-end",t.measure="latency-"+e+"-measure",this._newRequest("GET")._sendRequest()}else{var n=this;this._setRequesting(!1),setTimeout(function(){n._calculate()},0)}},r._calculate=function(){var e=this._latencies,t=!1,n=e.reduce(function(e,n){return t=t||0==e||0==n,e+n})/e.length;t&&console.warn(["At least one latency returned a zero value, this can be due to the configuration of your web server which","is probably using persistant connections. Check the documentation to solve this problem."].join(" ")),this.trigger("end",[n,e])},i}),n("modules/bandwidth",["modules/http","timing","utilities"],function(e,t,n){"use strict";var i=function(t,i){var r=["upload","download"];t=~r.indexOf(t)?t:"download",i=n.extend({dataSize:{upload:2097152,download:10485760,multiplier:2}},i),e.call(this,t,i),this._loadingType=t,this._timeoutOccured=!1,this._isRestarting=!1,this._lastLoadedValue=null,this._speedRecords=[],this._avgSpeed=null,this._requestID=0,this._progressID=0,this._timingLabels={start:null,progress:null,end:null,measure:null},this._initBandwidthConfig()},r=i.prototype=Object.create(e.prototype);return r.start=function(){var e=this._loadingType,t=this._options.dataSize,n=this._requestID++;this._timeoutOccured=!1,this._lastLoadedValue=null,this._speedRecords=[],this._isRestarting||this.trigger("start",["upload"==e?t.upload:t.download]);var i=this._timingLabels;i.start=e+"-"+n+"-start",i.progress=e+"-"+n+"-progress",i.end=e+"-"+n+"-end",i.measure=e+"-"+n+"-measure";var r="upload"==e?new Blob([new ArrayBuffer(t.upload)]):null;this._newRequest("POST",{size:t.download})._sendRequest(r)},r._initBandwidthConfig=function(){var e=this,n=this._loadingType,i="upload"==n?"xhr-upload-":"xhr-";this.on(i+"loadstart",function(){t.mark(e._timingLabels.start)}),this.on(i+"progress",function(t){e._progress(t)}),this.on(i+"timeout",function(){e._timeout()}),this.on(i+"loadend",function(){e._end()})},r._progress=function(e){var n=this._timingLabels,i=this._progressID++,r=n.progress+"-"+i,s=e.loaded;t.mark(r);var o,u=t.measure(n.measure+"-avg-"+i,n.start,r),a=s/u*1e3;if(this._lastLoadedValue){var l=t.measure(n.measure+"-instant-"+i,n.progress+"-"+(i-1),r);o=(s-this._lastLoadedValue)/l*1e3}else o=a;this._lastLoadedValue=s,this._avgSpeed=a,this._speedRecords.push(o),this.trigger("progress",[a,o])},r._timeout=function(){this._timeoutOccured=!0},r._end=function(){if(this._timeoutOccured)this._isRestarting=!1,this.trigger("end",[this._avgSpeed,this._speedRecords]);else{var e=this._loadingType,t=this._options.dataSize;t.upload*=t.multiplier,t.download*=t.multiplier,this.trigger("restart",["upload"==e?t.upload:t.download]),this._isRestarting=!0,this.start()}},i}),t(["modules/latency","modules/bandwidth"],function(e,t){"use strict";var n=function(n){this._modules={},this._setModule("latency",new e(n))._setModule("upload",new t("upload",n))._setModule("download",new t("download",n))},i=n.prototype;i.module=function(e){return this._modules[e]||null},i.isRequesting=function(){var e=this._modules,t=!1;for(var n in e)e.hasOwnProperty(n)&&(t=t||e[n].isRequesting());return t},i._setModule=function(e,t){var n=this;return t&&(this._modules[e]=t.on("_newRequest",function(){return!n.isRequesting()})),this},window.SpeedTest=n}),n("speedtest",function(){})}();
